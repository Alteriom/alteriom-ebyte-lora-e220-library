name: Create Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Run tests first - reuse the build-test workflow
  tests:
    uses: ./.github/workflows/build-test.yml

  release:
    needs: [tests]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Generate release notes
      id: release_notes
      run: |
        # Extract version from tag
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        
        # Generate release notes from CHANGELOG.md
        if [ -f "docs/CHANGELOG.md" ]; then
          # Extract current version section from changelog
          NOTES=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" docs/CHANGELOG.md || echo "Release $VERSION")
        else
          NOTES="Release $VERSION - Alteriom fork of EByte LoRa E220 Series Library with enhanced CI/CD"
        fi
        
        # Save notes to file for multiline content
        echo "$NOTES" > release_notes.txt
        echo "Generated release notes for version $VERSION"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: "Alteriom EByte LoRa E220 v${{ steps.release_notes.outputs.VERSION }}"
        body_path: release_notes.txt
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          library.properties
          library.json
          docs/CHANGELOG.md
          docs/DEPLOYMENT_GUIDE.md
          docs/README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Validate Library Package
      run: |
        echo "ðŸ” Final validation before Arduino Library Manager submission..."
        ./scripts/validate-library.sh

  # Publish to NPM
  npm-publish:
    needs: [tests, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js for NPM
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Install dependencies
      run: npm install --ignore-scripts
    
    - name: Create NPM package (unscoped)
      run: |
        # Create a temporary package.json for NPM (unscoped)
        cp package.json package.json.github.bak
        sed 's/"@alteriom\/alteriom-ebyte-lora-e220"/"alteriom-ebyte-lora-e220"/' package.json > package.json.npm
        cp package.json.npm package.json
    
    - name: Validate NPM package.json
      run: |
        echo "ðŸ“¦ Validating NPM package configuration..."
        npm run validate-library || echo "Library validation completed"
        
        # Check if package name is available (for first-time publishing)
        echo "ðŸ” Checking NPM package availability..."
        if npm view alteriom-ebyte-lora-e220 version 2>/dev/null; then
          echo "âœ… Package exists - this will be an update"
        else
          echo "ðŸ†• Package doesn't exist - this will be first publication"
        fi
    
    - name: Publish to NPM
      run: |
        echo "ðŸ“¦ Publishing to NPM..."
        npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    
    - name: Restore GitHub package.json
      run: |
        cp package.json.github.bak package.json
    
    - name: NPM Publication Success
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "================================"
        echo "ðŸŽ‰ NPM Publication Successful!"
        echo "================================"
        echo ""
        echo "ðŸ“¦ Package: alteriom-ebyte-lora-e220@$VERSION"
        echo "ðŸ”— NPM URL: https://www.npmjs.com/package/alteriom-ebyte-lora-e220"
        echo "ðŸ“¥ Install: npm install alteriom-ebyte-lora-e220"
        echo ""
        echo "ï¿½ Documentation:"
        echo "   - Arduino examples: examples/"
        echo "   - PlatformIO: platformio.ini"
        echo "================================"

  # Publish to GitHub Packages
  github-packages-publish:
    needs: [tests, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    continue-on-error: true  # Don't fail the release if GitHub Packages fails
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    
    - name: Setup Node.js for GitHub Packages
      uses: actions/setup-node@v6
      with:
        node-version: '18'
        registry-url: 'https://npm.pkg.github.com'
        scope: '@alteriom'
    
    - name: Install dependencies
      run: npm install --ignore-scripts
    
    - name: Validate GitHub Package configuration
      run: |
        echo "ðŸ“¦ Validating GitHub Package configuration..."
        echo "Package name: $(grep '"name"' package.json | cut -d'"' -f4)"
        echo "Registry: https://npm.pkg.github.com"
        echo "Scope: @alteriom"
        
        # Check if package exists
        echo "ï¿½ Checking GitHub Package availability..."
        if npm view @alteriom/alteriom-ebyte-lora-e220 version 2>/dev/null; then
          echo "âœ… Package exists - this will be an update"
        else
          echo "ðŸ†• Package doesn't exist - this will be first publication"
        fi
    
    - name: Publish to GitHub Packages
      run: |
        echo "ðŸ“¦ Publishing to GitHub Packages..."
        if npm publish; then
          echo "âœ… Successfully published to GitHub Packages"
        else
          echo "âš ï¸  GitHub Packages publishing failed. This might be due to:"
          echo "   1. Organization package permissions not enabled"
          echo "   2. Package name already exists"
          echo "   3. Authentication issues"
          echo ""
          echo "ðŸ”§ To enable GitHub Packages for the organization:"
          echo "   1. Go to Organization Settings â†’ Package management"
          echo "   2. Enable 'Allow members to publish packages'"
          echo "   3. Or publish under personal account instead"
          echo ""
          echo "ðŸ“¦ NPM package is still available: npm install alteriom-ebyte-lora-e220"
          exit 1
        fi
      env:
        NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: GitHub Packages Publication Success
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "================================"
        echo "ðŸŽ‰ GitHub Packages Publication Successful!"
        echo "================================"
        echo ""
        echo "ðŸ“¦ Package: @alteriom/alteriom-ebyte-lora-e220@$VERSION"
        echo "ðŸ”— GitHub URL: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/packages"
        echo "ðŸ“¥ Install: npm install @alteriom/alteriom-ebyte-lora-e220"
        echo ""
        echo "ðŸ”§ Installation requires .npmrc configuration:"
        echo "   echo '@alteriom:registry=https://npm.pkg.github.com' >> .npmrc"
        echo ""
        echo "ðŸ’¡ Note: GitHub Packages require authentication for installation"
        echo "================================"

  # Publish documentation to GitHub Wiki
  wiki-publish:
    needs: [tests, release]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    continue-on-error: true  # Don't fail the release if wiki update fails
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    
    - name: Check if Wiki exists and create initial page if needed
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "ðŸ“š Setting up GitHub Wiki for version $VERSION..."
        
        # Try to clone the wiki repository
        if git clone https://github.com/${{ github.repository }}.wiki.git wiki 2>/dev/null; then
          echo "âœ… Wiki repository exists"
        else
          echo "ðŸ“ Wiki doesn't exist yet. Creating it..."
          # Create a temporary wiki directory and initialize it
          mkdir -p wiki
          cd wiki
          git init
          git remote add origin https://github.com/${{ github.repository }}.wiki.git
          
          # Create initial Home page to initialize the wiki
          cat > Home.md << 'EOF'
        # Alteriom EByte LoRa E220 Series Library Wiki
        
        Welcome to the official wiki for the Alteriom EByte LoRa E220 Series Library!
        
        This wiki is automatically updated with each release.
        
        ## Quick Links
        
        - [Installation Guide](Installation)
        - [API Reference](API-Reference) 
        - [Examples](Examples)
        - [Complete Documentation](Complete-Documentation)
        - [Contributing Guidelines](Contributing)
        - [Changelog](Changelog)
        
        ## Getting Started
        
        The Alteriom EByte LoRa E220 Series Library provides support for EByte LoRa E220 LLCC68 devices with 5-10km range communication.
        
        ### Quick Installation
        
        **Arduino IDE:**
        1. Tools â†’ Manage Libraries
        2. Search: "Alteriom_EByte_LoRa_E220"
        3. Install
        
        **PlatformIO:**
        ```ini
        lib_deps = Alteriom/Alteriom_EByte_LoRa_E220@^1.1.0
        ```
        
        ## Features
        
        - Long Range Communication (5-10km)
        - Multi-Platform Support (Arduino, ESP32, ESP8266, STM32, Pi Pico)
        - Wake-on-Radio (WOR) support
        - Multiple messaging modes
        - Comprehensive examples
        - Automated CI/CD
        EOF
          
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add Home.md
          git commit -m "Initialize wiki with home page"
          
          # Push to create the wiki
          git push -u origin master || {
            echo "âš ï¸  Could not create wiki automatically. Wiki needs to be manually created first."
            echo "   Please go to https://github.com/${{ github.repository }}/wiki and create a page manually."
            cd ..
            exit 0
          }
          cd ..
          echo "âœ… Wiki initialized successfully"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Wiki Pages
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "ðŸ“š Updating GitHub Wiki for version $VERSION..."
        
        # Ensure we're in the wiki directory
        cd wiki || exit 0
        
        # Configure git
        git config user.name "GitHub Action"
        git config user.email "action@github.com"
        
        # Copy documentation files to wiki (overwrite existing)
        cp ../docs/README.md Home.md 2>/dev/null || cp ../README.md Home.md
        cp ../docs/original-documentation.md Complete-Documentation.md 2>/dev/null || echo "# Complete Documentation\n\nSee main repository for documentation." > Complete-Documentation.md
        cp ../docs/DEPLOYMENT_GUIDE.md Deployment-Guide.md 2>/dev/null || echo "# Deployment Guide\n\nSee main repository for deployment information." > Deployment-Guide.md
        cp ../docs/CONTRIBUTING.md Contributing.md 2>/dev/null || echo "# Contributing\n\nSee main repository for contributing guidelines." > Contributing.md
        cp ../docs/CHANGELOG.md Changelog.md 2>/dev/null || echo "# Changelog\n\nSee main repository for changelog." > Changelog.md
        
        # Create API Reference page
        cat > API-Reference.md << 'EOF'
        # API Reference
        
        This page contains the complete API reference for the Alteriom EByte LoRa E220 Library.
        
        ## Core Classes
        
        ### LoRa_E220
        
        The main class for interacting with EByte LoRa E220 devices.
        
        #### Constructors
        
        ```cpp
        LoRa_E220(byte txE220pin, byte rxE220pin, UART_BPS_RATE bpsRate = UART_BPS_RATE_9600);
        LoRa_E220(byte txE220pin, byte rxE220pin, byte auxPin, UART_BPS_RATE bpsRate = UART_BPS_RATE_9600);
        LoRa_E220(byte txE220pin, byte rxE220pin, byte auxPin, byte m0Pin, byte m1Pin, UART_BPS_RATE bpsRate = UART_BPS_RATE_9600);
        ```
        
        #### Methods
        
        - `begin()` - Initialize the device
        - `getConfiguration()` - Get current device configuration
        - `setConfiguration()` - Set device configuration
        - `sendMessage()` - Send a message
        - `receiveMessage()` - Receive a message
        - `sendFixedMessage()` - Send message to specific address
        - `sendBroadcastMessage()` - Send broadcast message
        
        For complete documentation, see [Complete Documentation](Complete-Documentation).
        EOF
        
        # Create Examples page
        cat > Examples.md << 'EOF'
        # Examples
        
        This page contains links and descriptions of all available examples.
        
        ## Basic Examples
        
        - **[01_getConfiguration](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/01_getConfiguration)** - Read device configuration
        - **[01_setConfiguration](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/01_setConfiguration)** - Configure device parameters
        - **[02_sendTransparentTransmission](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/02_sendTransparentTransmission)** - Simple message sending
        
        ## Advanced Examples
        
        - **[04_sendFixedTransmission](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/04_sendFixedTransmission)** - Targeted message delivery
        - **[05_sendFixedTransmissionStructure](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/05_sendFixedTransmissionStructure)** - Send structured data
        - **[06_sendWORMessage](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/06_sendWORMessage)** - Wake-on-Radio messaging
        - **[07_receiveMessages](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples/07_receiveMessages)** - Message reception handling
        
        ## Platform-Specific Examples
        
        Each example includes platform-specific configurations for:
        - Arduino UNO/Nano
        - ESP32
        - ESP8266
        - STM32
        - Raspberry Pi Pico
        
        For the complete code and wiring diagrams, visit the [examples directory](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/tree/main/examples).
        EOF
        
        # Create Installation Guide
        cat > Installation.md << 'EOF'
        # Installation Guide
        
        ## Arduino Library Manager
        
        1. Open Arduino IDE
        2. Go to **Tools** â†’ **Manage Libraries**
        3. Search for "**Alteriom_EByte_LoRa_E220**"
        4. Click **Install**
        
        ## PlatformIO
        
        Add to your `platformio.ini`:
        ```ini
        lib_deps = 
            Alteriom/Alteriom_EByte_LoRa_E220@^1.1.0
        ```
        
        ## NPM Package
        
        For MCP server integration:
        ```bash
        npm install alteriom-ebyte-lora-e220
        ```
        
        ## Manual Installation
        
        1. Download the latest release from [GitHub Releases](https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/releases)
        2. Extract to your Arduino libraries folder
        3. Restart Arduino IDE
        
        ## Supported Platforms
        
        - Arduino UNO/Nano/Mega
        - ESP32 (all variants)
        - ESP8266 (NodeMCU, Wemos D1, etc.)
        - STM32 (Blue Pill, Nucleo, etc.)
        - Raspberry Pi Pico
        - SAMD21/SAMD51 (Arduino MKR, Adafruit Feather)
        EOF
    
    - name: Commit and Push Wiki Changes
      run: |
        cd wiki || exit 0
        
        # Check if we have any changes
        if git diff --quiet && git diff --cached --quiet; then
          echo "No changes to commit to wiki"
          exit 0
        fi
        
        git add .
        git commit -m "Update documentation for release ${GITHUB_REF#refs/tags/v}" || {
          echo "Nothing to commit"
          exit 0
        }
        
        # Push changes
        git push || {
          echo "âš ï¸  Could not push to wiki. This may be the first time or wiki doesn't exist."
          echo "   Please create the wiki manually at: https://github.com/${{ github.repository }}/wiki"
          exit 0
        }
        
        echo "âœ… Wiki updated successfully!"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Wiki Publication Success
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "================================"
        echo "ðŸ“š Wiki Publication Successful!"
        echo "================================"
        echo ""
        echo "ðŸ“– Wiki URL: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki"
        echo "ðŸ  Home Page: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/Home"
        echo "ðŸ“‹ API Reference: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/API-Reference"
        echo "ðŸ“š Examples: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/Examples"
        echo ""
        echo "ðŸ“ Updated pages:"
        echo "   - Home (from docs/README.md)"
        echo "   - Complete Documentation (from docs/original-documentation.md)"
        echo "   - API Reference (generated)"
        echo "   - Examples (generated)"
        echo "   - Installation Guide (generated)"
        echo "   - Contributing Guidelines (from docs/CONTRIBUTING.md)"
        echo "   - Changelog (from docs/CHANGELOG.md)"
        echo "================================"

  submission-instructions:
    needs: [release, npm-publish, github-packages-publish]
    runs-on: ubuntu-latest
    if: always() && needs.release.result == 'success'
    
    steps:
    - name: Arduino Library Manager Submission Instructions
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        echo "================================"
        echo "ðŸš€ Arduino Library Manager Submission"
        echo "================================"
        echo ""
        echo "âœ… Release $VERSION has been created successfully!"
        echo ""
        echo "ðŸ“‹ Automated submission check will run separately"
        echo "ðŸ”„ Check Arduino submission workflow for status"
        echo ""
        echo "ðŸ’¡ Manual submission (if needed):"
        echo "1. Go to: https://github.com/arduino/library-registry"
        echo "2. Fork the repository"
        echo "3. Add to repositories.txt: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library"
        echo "4. Create pull request"
        echo ""
        echo "ï¿½ Monitor Arduino indexer logs:"
        echo "   http://downloads.arduino.cc/libraries/logs/github.com/Alteriom/EByte_LoRa_E220_Series_Library/"
        echo ""
        echo "ðŸ’¡ Additional Resources:"
        echo "   - GitHub Release: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/releases/tag/${{ github.ref_name }}"
        echo "   - NPM Package: https://www.npmjs.com/package/alteriom-ebyte-lora-e220"
        echo "   - Documentation: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/blob/main/README.md"
        echo "================================"

  # Trigger Arduino submission workflow
  arduino-submission:
    needs: [release]
    if: needs.release.result == 'success'
    uses: ./.github/workflows/arduino-submission.yml