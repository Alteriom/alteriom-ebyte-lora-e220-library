name: Test PlatformIO Library
permissions:
  contents: read

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'library.json'
      - 'LoRa_E220.*'
      - '.github/workflows/test-platformio.yml'

jobs:
  test-compilation:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - platform: "atmelavr"
            board: "uno"
            name: "Arduino UNO"
          - platform: "espressif32" 
            board: "esp32dev"
            name: "ESP32"
          - platform: "espressif8266"
            board: "nodemcuv2"
            name: "ESP8266"
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Install PlatformIO Core
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        pio --version
    
    - name: Install platform
      run: |
        echo "Installing platform: ${{ matrix.platform }}"
        pio pkg install --global --platform ${{ matrix.platform }}
    
    - name: Validate library.json
      run: |
        echo "ğŸ“‹ Validating library.json..."
        if [ ! -f "library.json" ]; then
          echo "âŒ library.json not found"
          exit 1
        fi
        
        # Check JSON validity
        python -c "import json; json.load(open('library.json'))" || {
          echo "âŒ Invalid JSON in library.json"
          exit 1
        }
        
        echo "âœ… library.json is valid"
        
        # Display library info
        echo "ğŸ“š Library Information:"
        echo "Name: $(python -c "import json; print(json.load(open('library.json'))['name'])")"
        echo "Version: $(python -c "import json; print(json.load(open('library.json'))['version'])")"
        echo "Description: $(python -c "import json; print(json.load(open('library.json'))['description'][:100])...")..."
    
    - name: Test library compilation for ${{ matrix.name }}
      run: |
        echo "ğŸ”§ Testing compilation for ${{ matrix.name }} (${{ matrix.board }})"
        
        # Create test project
        mkdir test_project
        cd test_project
        
        # Initialize PlatformIO project
        pio project init --board ${{ matrix.board }}
        
        # Create a simple test that includes our library
        cat > src/main.cpp << 'EOF'
        #include <Arduino.h>
        
        // Include library headers to test compilation
        #include "LoRa_E220.h"
        
        // Create instance to test constructor compilation
        // Use platform-appropriate constructor
        #if defined(ESP32)
          // ESP32: Use Hardware Serial2
          LoRa_E220 e220ttl(&Serial2, UART_BPS_RATE_9600);
        #elif defined(ESP8266)
          // ESP8266: Use Hardware Serial1 (Serial2 doesn't exist)
          LoRa_E220 e220ttl(&Serial1, UART_BPS_RATE_9600);
        #else
          // Arduino/other: Use Software Serial pins
          LoRa_E220 e220ttl(2, 3, UART_BPS_RATE_9600);
        #endif
        
        void setup() {
          Serial.begin(9600);
          Serial.println("Library compilation test - SUCCESS");
        }
        
        void loop() {
          delay(1000);
        }
        EOF
        
        # Add library dependency using local path
        echo "" >> platformio.ini
        echo "; Add local library dependency" >> platformio.ini
        echo "lib_deps = file://.." >> platformio.ini
        
        # Show the configuration
        echo "ğŸ“„ platformio.ini content:"
        cat platformio.ini
        echo ""
        
        # Test compilation
        echo "ğŸ”¨ Compiling for ${{ matrix.board }}..."
        if pio run; then
          echo "âœ… Compilation successful for ${{ matrix.name }}"
        else
          echo "âŒ Compilation failed for ${{ matrix.name }}"
          echo "ğŸ“‹ Build log above shows the error details"
          exit 1
        fi
    
    - name: Test library package validation
      if: matrix.board == 'uno'  # Only run once
      run: |
        echo "ğŸ“¦ Testing library package validation..."
        cd ..  # Go back to library root
        
        # Test package validation
        if pio pkg pack --output ./dist; then
          echo "âœ… Library package validation successful"
          echo "ğŸ“ Package contents:"
          ls -la ./dist/
        else
          echo "âŒ Library package validation failed"
          exit 1
        fi

  summary:
    runs-on: ubuntu-latest
    needs: [test-compilation]
    if: always()
    
    steps:
    - name: Test Results Summary
      run: |
        echo "================================"
        echo "ğŸ§ª PlatformIO Library Test Results"
        echo "================================"
        echo ""
        
        if [ "${{ needs.test-compilation.result }}" == "success" ]; then
          echo "âœ… All compilation tests passed!"
          echo ""
          echo "âœ… Arduino UNO compilation: SUCCESS"
          echo "âœ… ESP32 compilation: SUCCESS" 
          echo "âœ… ESP8266 compilation: SUCCESS"
          echo "âœ… Library package validation: SUCCESS"
          echo ""
          echo "ğŸš€ Library is ready for PlatformIO Registry publishing!"
          echo ""
          echo "ğŸ“¦ Next steps:"
          echo "1. Set up PLATFORMIO_AUTH_TOKEN in repository secrets"
          echo "2. Create a release tag: git tag v1.1.6 && git push origin v1.1.6"
          echo "3. The PlatformIO publishing workflow will run automatically"
        else
          echo "âŒ Some tests failed"
          echo ""
          echo "ğŸ”§ Check the compilation test logs above for details"
          echo "Common issues to check:"
          echo "- Missing header files"
          echo "- Syntax errors in library code"
          echo "- Platform-specific compatibility issues"
          echo "- library.json configuration errors"
        fi
        echo ""
        echo "ğŸ“š Documentation:"
        echo "- PlatformIO Publishing Guide: docs/PLATFORMIO_PUBLISHING_GUIDE.md"
        echo "- Library Registry: https://registry.platformio.org/"
        echo "================================"