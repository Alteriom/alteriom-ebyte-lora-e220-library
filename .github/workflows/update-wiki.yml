name: Update Wiki

on:
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update all wiki pages (even if no changes)'
        required: false
        default: false
        type: boolean
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'examples/**'
      - '.github/workflows/update-wiki.yml'

jobs:
  update-wiki:
    runs-on: ubuntu-latest
    continue-on-error: true  # Don't fail if wiki update fails
    
    permissions:
      contents: write  # Need write permission for wiki
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
    
    - name: Update GitHub Wiki
      run: |
        echo "üìö Updating GitHub Wiki..."
        
        # Get current version from library.properties
        VERSION=$(grep "version=" library.properties | cut -d'=' -f2)
        echo "üìã Current library version: $VERSION"
        
        # Configure git with token for authentication
        git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
        
        # Try to clone the wiki repository
        if git clone https://github.com/${{ github.repository }}.wiki.git wiki 2>/dev/null; then
          echo "‚úÖ Wiki repository exists"
        else
          echo "üìù Wiki doesn't exist yet. Creating it..."
          # Create a temporary wiki directory and initialize it
          mkdir -p wiki
          cd wiki
          git init
          git remote add origin https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git
          
          # Create initial Home page to initialize the wiki
          cat > Home.md << 'EOF'
        # Alteriom EByte LoRa E220 Series Library Wiki
        
        Welcome to the official wiki for the Alteriom EByte LoRa E220 Series Library!
        
        This wiki is automatically updated with each release.
        
        ## Navigation
        
        - [API Reference](API-Reference) 
        - [Examples](Examples)
        - [Installation Guide](Installation)
        - [Complete Documentation](Complete-Documentation)
        - [Deployment Guide](Deployment-Guide)
        - [Contributing](Contributing)
        - [Changelog](Changelog)
        
        ## Quick Links
        
        - **Repository**: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library
        - **Arduino Library Manager**: Search "Alteriom_EByte_LoRa_E220"
        - **NPM Package**: `npm install alteriom-ebyte-lora-e220`
        - **Issues**: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/issues
        
        ## About
        
        This library provides comprehensive support for EByte LoRa E220 LLCC68 devices with:
        - 5-10km range communication
        - Multi-platform support (Arduino, ESP32, ESP8266, STM32, Raspberry Pi Pico)
        - Automated CI/CD and releases
        - Arduino Library Manager compliance
        EOF
          
          git add Home.md
          git commit -m "Initialize wiki with home page"
          
          # Push to create the wiki
          git push -u origin master || {
            echo "‚ö†Ô∏è  Could not create wiki automatically. Wiki needs to be manually created first."
            echo "   Please go to https://github.com/${{ github.repository }}/wiki and create a page manually."
            cd ..
            exit 0
          }
          cd ..
          echo "‚úÖ Wiki initialized successfully"
        fi
        
        # Ensure we're in the wiki directory
        cd wiki || exit 0
        
        # Configure git with authentication
        git config user.name "GitHub Action"
        git config user.email "action@github.com"
        git remote set-url origin https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.wiki.git
        
        # Pull latest changes
        git pull origin master 2>/dev/null || true
        
        echo "üìÑ Updating wiki pages..."
        
        # Copy documentation files to wiki (overwrite existing)
        cp ../docs/README.md Home.md 2>/dev/null || cp ../README.md Home.md
        cp ../docs/original-documentation.md Complete-Documentation.md 2>/dev/null || echo "# Complete Documentation\n\nSee main repository for documentation." > Complete-Documentation.md
        cp ../docs/DEPLOYMENT_GUIDE.md Deployment-Guide.md 2>/dev/null || echo "# Deployment Guide\n\nSee main repository for deployment information." > Deployment-Guide.md
        cp ../docs/CONTRIBUTING.md Contributing.md 2>/dev/null || echo "# Contributing\n\nSee main repository for contributing guidelines." > Contributing.md
        cp ../docs/CHANGELOG.md Changelog.md 2>/dev/null || echo "# Changelog\n\nSee main repository for changelog." > Changelog.md
        
        # Create API Reference page
        cat > API-Reference.md << 'EOF'
        # API Reference
        
        This page contains the complete API reference for the Alteriom EByte LoRa E220 Library.
        
        ## Core Classes
        
        ### LoRa_E220
        
        The main class for interacting with EByte LoRa E220 devices.
        
        #### Constructor
        ```cpp
        LoRa_E220(HardwareSerial* serial, byte auxPin, byte m0Pin, byte m1Pin)
        LoRa_E220(SoftwareSerial* serial, byte auxPin, byte m0Pin, byte m1Pin)
        ```
        
        #### Core Methods
        
        - `begin()` - Initialize the device
        - `getConfiguration()` - Read current device configuration
        - `setConfiguration(Configuration configuration)` - Write device configuration
        - `sendMessage(String message)` - Send transparent transmission
        - `sendFixedMessage(byte ADDH, byte ADDL, byte CHAN, String message)` - Send fixed transmission
        - `sendBroadcastFixedMessage(byte CHAN, String message)` - Send broadcast message
        - `receiveMessage()` - Receive incoming messages
        - `getModuleInformation()` - Get device information and capabilities
        
        #### Configuration Methods
        
        - `setMode(MODE_TYPE mode)` - Set device operating mode
        - `getMode()` - Get current operating mode
        - `setAddress(word address)` - Set device address
        - `setChannel(byte channel)` - Set communication channel
        - `setSpeedParityBit(UART_PARITY parity)` - Set UART parity
        - `setSpeedUARTDatte(UART_BPS_TYPE baudRate)` - Set UART baud rate
        - `setSpeedAirDataRate(AIR_DATA_RATE airDataRate)` - Set air data rate
        
        ## Data Structures
        
        ### Configuration
        Main configuration structure for device settings.
        
        ### ModuleInformation  
        Device information including model, version, and capabilities.
        
        ### ResponseStatus
        Result status for operations with descriptive messages.
        
        For complete code examples, see the [Examples](Examples) page.
        EOF
        
        # Create Examples page
        cat > Examples.md << 'EOF'
        # Examples
        
        This page contains examples for using the Alteriom EByte LoRa E220 Library.
        
        ## Basic Usage Examples
        
        ### 1. Device Configuration
        
        Read and display current device configuration:
        
        ```cpp
        #include "LoRa_E220.h"
        
        LoRa_E220 e220ttl(&Serial2, 15, 21, 19); // ESP32 configuration
        
        void setup() {
          Serial.begin(9600);
          e220ttl.begin();
          
          ResponseStructContainer c = e220ttl.getConfiguration();
          Configuration configuration = *(Configuration*) c.data;
          
          Serial.println("Current Configuration:");
          Serial.print("Address: "); Serial.println(configuration.ADDH * 256 + configuration.ADDL);
          Serial.print("Channel: "); Serial.println(configuration.CHAN);
          Serial.print("Speed: "); Serial.println(configuration.SPED.getUARTBaudRate());
          
          c.close();
        }
        ```
        
        ### 2. Send Message
        
        Send a simple message using transparent transmission:
        
        ```cpp
        void loop() {
          ResponseStatus rs = e220ttl.sendMessage("Hello from Arduino!");
          
          if (rs.code == 1) {
            Serial.println("Message sent successfully");
          } else {
            Serial.println("Error sending message: " + rs.getResponseDescription());
          }
          
          delay(5000);
        }
        ```
        
        ### 3. Receive Messages
        
        Listen for incoming messages:
        
        ```cpp
        void loop() {
          if (e220ttl.available()) {
            ResponseContainer rc = e220ttl.receiveMessage();
            
            if (rc.status.code == 1) {
              Serial.println("Received: " + rc.data);
            }
            
            rc.close();
          }
          
          delay(100);
        }
        ```
        
        ### 4. Fixed Transmission
        
        Send message to specific address and channel:
        
        ```cpp
        // Send to address 0x0002, channel 23
        ResponseStatus rs = e220ttl.sendFixedMessage(0x00, 0x02, 23, "Fixed message");
        ```
        
        ### 5. Broadcast Message
        
        Send broadcast message on specific channel:
        
        ```cpp
        ResponseStatus rs = e220ttl.sendBroadcastFixedMessage(23, "Broadcast to all devices");
        ```
        
        ## Advanced Examples
        
        ### Configuration with Custom Settings
        
        ```cpp
        Configuration configuration;
        configuration.ADDH = 0x00;
        configuration.ADDL = 0x01;
        configuration.CHAN = 23;
        configuration.SPED.uartBaudRate = UART_BPS_9600;
        configuration.SPED.airDataRate = AIR_DATA_RATE_2_4K;
        configuration.SPED.uartParity = MODE_00_8N1;
        
        ResponseStatus rs = e220ttl.setConfiguration(configuration, WRITE_CFG_PWR_DWN_SAVE);
        ```
        
        ### Wake on Radio (WOR)
        
        ```cpp
        // Set WOR transmitter mode
        ResponseStatus rs = e220ttl.setMode(MODE_1_WOR_TRANSMITTER);
        
        // Send WOR message
        rs = e220ttl.sendMessage("WOR Message");
        
        // Return to normal mode
        rs = e220ttl.setMode(MODE_0_NORMAL);
        ```
        
        ## Platform-Specific Examples
        
        See the `examples/` directory in the repository for complete, ready-to-use examples for:
        - Arduino Uno/Nano
        - ESP32
        - ESP8266  
        - STM32
        - Raspberry Pi Pico
        
        Each example includes detailed comments and wiring diagrams.
        EOF
        
        # Create Installation page
        cat > Installation.md << 'EOF'
        # Installation Guide
        
        Multiple installation methods are available for the Alteriom EByte LoRa E220 Library.
        
        ## Arduino IDE Installation
        
        ### Method 1: Arduino Library Manager (Recommended)
        
        1. Open Arduino IDE
        2. Go to **Tools** ‚Üí **Manage Libraries**
        3. Search for: `Alteriom_EByte_LoRa_E220`
        4. Click **Install**
        
        ### Method 2: Manual Installation
        
        1. Download the latest release from: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/releases
        2. Extract the ZIP file
        3. Copy the folder to your Arduino libraries directory:
           - **Windows**: `Documents\Arduino\libraries\`
           - **macOS**: `~/Documents/Arduino/libraries/`
           - **Linux**: `~/Arduino/libraries/`
        4. Restart Arduino IDE
        
        ## PlatformIO Installation
        
        Add to your `platformio.ini` file:
        
        ```ini
        [env:your_board]
        platform = your_platform
        board = your_board
        framework = arduino
        lib_deps = 
            alteriom/Alteriom_EByte_LoRa_E220@^1.1.5
        ```
        
        ## NPM Installation (Advanced)
        
        For Node.js projects or advanced integration:
        
        ```bash
        # Public NPM package (no authentication required)
        npm install alteriom-ebyte-lora-e220
        
        # GitHub Packages (authentication required)
        echo "@alteriom:registry=https://npm.pkg.github.com" >> .npmrc
        npm install @alteriom/alteriom-ebyte-lora-e220
        ```
        
        ## Hardware Requirements
        
        ### Supported Boards
        - Arduino Uno/Nano/Pro Mini
        - ESP32 (all variants)
        - ESP8266 (NodeMCU, Wemos D1, etc.)
        - STM32 (Blue Pill, etc.)
        - Raspberry Pi Pico
        - SAMD21 (Arduino Zero, etc.)
        
        ### Supported E220 Modules
        - E220-400T22D (22dBm, 433MHz)
        - E220-400T30D (30dBm, 433MHz)
        - E220-900T22D (22dBm, 915MHz)
        - E220-900T30D (30dBm, 915MHz)
        - All E220 series with LLCC68 chipset
        
        ### Wiring
        
        Basic connections (adjust pins for your board):
        
        | E220 Pin | Arduino | ESP32 | ESP8266 |
        |----------|---------|-------|---------|
        | VCC      | 3.3V    | 3.3V  | 3.3V    |
        | GND      | GND     | GND   | GND     |
        | RX       | Pin 2   | GPIO16| GPIO13  |
        | TX       | Pin 3   | GPIO17| GPIO15  |
        | AUX      | Pin 4   | GPIO15| GPIO12  |
        | M0       | Pin 5   | GPIO21| GPIO14  |
        | M1       | Pin 6   | GPIO19| GPIO4   |
        
        **Important**: Use 3.3V power supply. For 5V boards, use voltage dividers on data lines.
        
        ## Verification
        
        Test your installation with this simple sketch:
        
        ```cpp
        #include "LoRa_E220.h"
        
        LoRa_E220 e220ttl(&Serial2, 15, 21, 19); // Adjust pins for your board
        
        void setup() {
          Serial.begin(9600);
          e220ttl.begin();
          
          Serial.println("Testing E220 Library...");
          
          ResponseStructContainer c = e220ttl.getConfiguration();
          if (c.status.code == 1) {
            Serial.println("‚úÖ Library working correctly!");
            Configuration configuration = *(Configuration*) c.data;
            Serial.print("Device address: ");
            Serial.println(configuration.ADDH * 256 + configuration.ADDL);
          } else {
            Serial.println("‚ùå Library test failed: " + c.status.getResponseDescription());
          }
          
          c.close();
        }
        
        void loop() {
          // Your code here
        }
        ```
        
        ## Troubleshooting
        
        ### Common Issues
        
        1. **"Library not found"**
           - Restart Arduino IDE after installation
           - Check library is in correct directory
           - Verify library name spelling
        
        2. **"No response from device"**
           - Check wiring connections
           - Verify power supply (3.3V)
           - Check if AUX pin is properly connected
           - Try different baud rates
        
        3. **"Compilation errors"**
           - Update to latest Arduino IDE version
           - Check board package is up to date
           - Verify correct board selected
        
        ### Getting Help
        
        - **GitHub Issues**: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/issues
        - **Arduino Forum**: https://forum.arduino.cc/
        - **Documentation**: See other wiki pages and repository README
        EOF
        
        # Check if there are any changes
        if [[ "${{ github.event.inputs.force_update }}" == "true" ]] || git status --porcelain | grep -q .; then
          echo "üìù Changes detected or force update requested. Committing updates..."
          
          git add .
          git commit -m "Auto-update wiki documentation (version $VERSION)" || {
            echo "‚ÑπÔ∏è  No changes to commit"
            exit 0
          }
          
          # Push changes
          git push origin master || {
            echo "‚ö†Ô∏è  Could not push wiki updates. Check repository wiki permissions."
            echo "   Wiki pages were created locally but couldn't be pushed to GitHub."
            exit 1
          }
          
          echo "‚úÖ Wiki updated successfully!"
        else
          echo "‚ÑπÔ∏è  No changes detected in wiki content"
        fi
        
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Wiki Update Summary
      if: always()
      run: |
        VERSION=$(grep "version=" library.properties | cut -d'=' -f2)
        echo "================================"
        echo "üìö Wiki Update Complete!"
        echo "================================"
        echo ""
        echo "üìã Library Version: $VERSION"
        echo "üîó Wiki URLs:"
        echo "üè† Home Page: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/Home"
        echo "üìã API Reference: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/API-Reference"
        echo "üìö Examples: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/Examples"
        echo "üì• Installation: https://github.com/Alteriom/EByte_LoRa_E220_Series_Library/wiki/Installation"
        echo ""
        echo "üîÑ Wiki is automatically updated when:"
        echo "   - Documentation files change (docs/**)"
        echo "   - README.md changes"
        echo "   - Examples change (examples/**)"
        echo "   - Manual trigger via GitHub Actions"
        echo "================================"